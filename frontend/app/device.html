<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Details - WaterIoT</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="/app/dashboard.html" class="logo">üíß WaterIoT</a>
                <ul class="nav-links"></ul>
            </nav>
        </div>
    </header>

    <main style="padding: 2rem 0;">
        <div class="container">
            <div style="margin-bottom: 2rem;">
                <a href="/app/dashboard.html" style="color: var(--primary-color); text-decoration: none;">&larr; Back to Dashboard</a>
            </div>

            <!-- Device Info -->
            <div class="card" id="deviceInfo">
                <div class="spinner"></div>
            </div>

            <!-- Quick Commands -->
            <div class="card">
                <div class="card-header">Quick Commands</div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="sendCommand('VALVE_OPEN')">Open Valve</button>
                    <button class="btn btn-danger" onclick="sendCommand('VALVE_CLOSE')">Close Valve</button>
                    <button class="btn btn-warning" onclick="sendCommand('SHUT_OFF')">Emergency Shut Off</button>
                    <button class="btn btn-primary" onclick="showSetFlowModal()">Set Flow Rate</button>
                </div>
            </div>

            <!-- Sensor Data History -->
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <span style="font-weight: 600;">üìä Sensor Data History (Raspberry Pi)</span>
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: nowrap;">
                        <select id="valveFilterSelect" onchange="applyFilters()" class="form-control" style="max-width: 140px; font-size: 13px; padding: 0.4rem 0.6rem;">
                            <option value="all">üîç All Valves</option>
                            <option value="OPEN">‚úì Open Only</option>
                            <option value="CLOSED">‚úó Closed Only</option>
                            <option value="PARTIAL">‚óê Partial Only</option>
                        </select>
                        <select id="limitSelect" onchange="loadReadings()" class="form-control" style="max-width: 100px; font-size: 13px; padding: 0.4rem 0.6rem;">
                            <option value="20">Last 20</option>
                            <option value="50">Last 50</option>
                            <option value="100">Last 100</option>
                            <option value="500">Last 500</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadReadings()" style="font-size: 13px; padding: 0.4rem 0.8rem;">üîÑ Refresh</button>
                    </div>
                </div>
                <div id="filterInfo" style="padding: 0.75rem 1rem; background: #f8f9fa; border-bottom: 1px solid var(--border-color); display: none;"></div>
                <div id="readingsTable" style="min-height: 100px;"></div>
            </div>

            <!-- ML Inference Events -->
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600;">ü§ñ ML Fixture Detection Events</span>
                    <button class="btn btn-secondary" onclick="loadInferences()" style="font-size: 13px; padding: 0.4rem 0.8rem;">üîÑ Refresh</button>
                </div>
                <div id="inferencesTable" style="min-height: 100px;"></div>
            </div>

            <div class="grid grid-2">
                <!-- Recent Readings Summary -->
                <div class="card">
                    <div class="card-header">Recent Activity</div>
                    <div id="readingsList"></div>
                </div>

                <!-- Command History -->
                <div class="card">
                    <div class="card-header">Command History</div>
                    <div id="commandsList"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Set Flow Modal -->
    <div id="setFlowModal" class="modal-overlay hidden">
        <div class="card" style="max-width: 400px; width: 90%; margin: 0;">
            <div class="card-header">
                Set Flow Rate
                <button onclick="hideSetFlowModal()" style="float: right; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Flow Rate (L/min)</label>
                <input type="number" id="flowRateInput" class="form-control" step="0.1" min="0" max="20" value="5">
                <input type="range" id="flowRateSlider" min="0" max="20" step="0.1" value="5" style="width: 100%; margin-top: 0.5rem;">
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-primary" onclick="sendFlowCommand()">Send</button>
                <button class="btn btn-secondary" onclick="hideSetFlowModal()">Cancel</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 WaterIoT. All rights reserved.</p>
        </div>
    </footer>

    <script src="/js/app.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const deviceId = urlParams.get('id');
        let device = null;

        async function loadDevice() {
            try {
                device = await apiRequest(`/devices/${deviceId}`);
                renderDeviceInfo();
                
                await loadReadings();
                await loadInferences();
                await loadCommands();
            } catch (error) {
                console.error('Error loading device:', error);
                showAlert('Failed to load device', 'error');
            }
        }

        function renderDeviceInfo() {
            const container = document.getElementById('deviceInfo');
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <h1 style="margin-bottom: 0.5rem;">${device.name}</h1>
                        <p class="text-muted">${device.deviceUid} ‚Ä¢ ${device.location || 'No location'}</p>
                    </div>
                    ${getStatusBadge(device.status)}
                </div>
                <div class="grid grid-3" style="margin-top: 1.5rem;">
                    <div>
                        <div class="text-muted" style="font-size: 0.875rem;">Model</div>
                        <div style="font-weight: 500;">${device.model || 'N/A'}</div>
                    </div>
                    <div>
                        <div class="text-muted" style="font-size: 0.875rem;">Firmware</div>
                        <div style="font-weight: 500;">${device.firmwareVersion || 'N/A'}</div>
                    </div>
                    <div>
                        <div class="text-muted" style="font-size: 0.875rem;">Last Seen</div>
                        <div style="font-weight: 500;">${formatDateTime(device.lastSeenAt)}</div>
                    </div>
                </div>
            `;
        }

        let allReadings = []; // T√ºm verileri sakla

        async function loadReadings() {
            const limit = document.getElementById('limitSelect')?.value || 20;
            
            try {
                const readings = await apiRequest(`/devices/${deviceId}/readings?limit=${limit}`);
                allReadings = readings; // T√ºm verileri sakla
                applyFilters(); // Filtreleri uygula
                renderReadingsSummary(readings.slice(0, 5)); // Son 5 tane √∂zet i√ßin
            } catch (error) {
                console.error('Error loading readings:', error);
                document.getElementById('readingsTable').innerHTML = 
                    '<p class="text-center text-muted" style="padding: 2rem;">Failed to load readings</p>';
            }
        }

        function applyFilters() {
            const valveFilter = document.getElementById('valveFilterSelect')?.value || 'all';
            
            let filteredReadings = [...allReadings];
            
            // Valve filter uygula
            if (valveFilter !== 'all') {
                filteredReadings = filteredReadings.filter(r => r.valveState === valveFilter);
            }
            
            // Filter bilgisini g√∂ster
            updateFilterInfo(filteredReadings.length, allReadings.length, valveFilter);
            
            // Tabloyu render et
            renderReadingsTable(filteredReadings);
        }

        function updateFilterInfo(filtered, total, valveFilter) {
            const infoDiv = document.getElementById('filterInfo');
            
            if (valveFilter === 'all') {
                infoDiv.style.display = 'none';
            } else {
                const filterLabels = {
                    'OPEN': '‚úì Open Valve',
                    'CLOSED': '‚úó Closed Valve',
                    'PARTIAL': '‚óê Partial Valve'
                };
                infoDiv.style.display = 'block';
                infoDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>
                            üîç Filter active: <strong>${filterLabels[valveFilter]}</strong>
                        </span>
                        <span style="color: #666;">
                            Showing ${filtered} of ${total} readings
                            ${filtered === 0 ? '‚Ä¢ <span style="color: var(--warning-color);">No data matches filter</span>' : ''}
                        </span>
                    </div>
                `;
            }
        }

        function renderReadingsTable(readings) {
            const container = document.getElementById('readingsTable');
            
            if (readings.length === 0) {
                container.innerHTML = '<p class="text-muted text-center" style="padding: 2rem;">No data received from Raspberry Pi yet</p>';
                return;
            }
            
            container.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                        <thead>
                            <tr style="background: var(--light-bg); border-bottom: 2px solid var(--border-color);">
                                <th style="padding: 0.75rem; text-align: left;">#</th>
                                <th style="padding: 0.75rem; text-align: left;">Timestamp</th>
                                <th style="padding: 0.75rem; text-align: right;">Flow Rate</th>
                                <th style="padding: 0.75rem; text-align: right;">Volume Œî</th>
                                <th style="padding: 0.75rem; text-align: right;">Total Volume</th>
                                <th style="padding: 0.75rem; text-align: center;">Valve</th>
                                <th style="padding: 0.75rem; text-align: center;">Battery</th>
                                <th style="padding: 0.75rem; text-align: center;">Signal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${readings.map((reading, index) => `
                                <tr style="border-bottom: 1px solid var(--border-color); ${index % 2 === 0 ? 'background: #fafafa;' : ''}">
                                    <td style="padding: 0.75rem; color: #666;">${readings.length - index}</td>
                                    <td style="padding: 0.75rem;">
                                        <div style="font-weight: 500;">${formatDate(reading.timestamp)}</div>
                                        <div style="color: #666; font-size: 0.8rem;">${formatTime(reading.timestamp)}</div>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; font-weight: 500; color: var(--primary-color);">
                                        ${reading.flowRateLpm ? formatNumber(reading.flowRateLpm) + ' L/min' : '-'}
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right;">
                                        ${reading.volumeLitersDelta ? formatNumber(reading.volumeLitersDelta) + ' L' : '-'}
                                    </td>
                                    <td style="padding: 0.75rem; text-align: right; font-weight: 500;">
                                        ${reading.volumeLitersTotal ? formatNumber(reading.volumeLitersTotal) + ' L' : '-'}
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center;">
                                        ${reading.valveState ? getValveBadge(reading.valveState) : '-'}
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center;">
                                        ${reading.batteryPct ? getBatteryDisplay(reading.batteryPct) : '-'}
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center;">
                                        ${reading.signalRssi ? getSignalDisplay(reading.signalRssi) : '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="padding: 1rem; text-align: center; color: #666; font-size: 0.875rem; border-top: 1px solid var(--border-color); background: var(--light-bg);">
                    Showing ${readings.length} readings ‚Ä¢ Last updated: ${new Date().toLocaleString()}
                </div>
            `;
        }

        function renderReadingsSummary(readings) {
            const container = document.getElementById('readingsList');
            
            if (readings.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No recent activity</p>';
                return;
            }
            
            container.innerHTML = readings.map(reading => `
                <div style="border-bottom: 1px solid var(--border-color); padding: 0.75rem 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <span style="font-weight: 500;">${formatDateTime(reading.timestamp)}</span>
                        ${reading.valveState ? getStatusBadge(reading.valveState) : ''}
                    </div>
                    <div class="text-muted" style="font-size: 0.875rem;">
                        Flow: ${reading.flowRateLpm ? formatNumber(reading.flowRateLpm) + ' L/min' : '-'} ‚Ä¢ 
                        Volume: ${reading.volumeLitersDelta ? formatNumber(reading.volumeLitersDelta) + ' L' : '-'}
                        ${reading.batteryPct ? ` ‚Ä¢ Battery: ${reading.batteryPct}%` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getValveBadge(state) {
            const colors = {
                'OPEN': 'success',
                'CLOSED': 'danger',
                'PARTIAL': 'warning'
            };
            return `<span class="badge badge-${colors[state] || 'secondary'}" style="font-size: 0.75rem;">${state}</span>`;
        }

        function getBatteryDisplay(pct) {
            const color = pct > 50 ? '#22c55e' : pct > 20 ? '#f59e0b' : '#ef4444';
            return `<span style="color: ${color}; font-weight: 500;">${pct}%</span>`;
        }

        function getSignalDisplay(rssi) {
            const strength = rssi > -50 ? 'üì∂' : rssi > -70 ? 'üì∂' : 'üì°';
            return `<span title="${rssi} dBm">${strength} ${rssi}</span>`;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            // Backend UTC g√∂nderiyor ama Z eklemediƒüi i√ßin local olarak algƒ±lanƒ±yor
            // UTC olduƒüunu belirtmek i√ßin Z ekliyoruz
            const dateWithTimezone = dateString.includes('Z') ? dateString : dateString + 'Z';
            const date = new Date(dateWithTimezone);
            return date.toLocaleDateString('tr-TR', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatTime(dateString) {
            if (!dateString) return '-';
            // Backend UTC g√∂nderiyor ama Z eklemediƒüi i√ßin local olarak algƒ±lanƒ±yor
            const dateWithTimezone = dateString.includes('Z') ? dateString : dateString + 'Z';
            const date = new Date(dateWithTimezone);
            return date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        async function loadCommands() {
            try {
                const commands = await apiRequest(`/devices/${deviceId}/commands?limit=10`);
                renderCommands(commands);
            } catch (error) {
                console.error('Error loading commands:', error);
            }
        }

        async function loadInferences() {
            try {
                const inferences = await apiRequest(`/devices/${deviceId}/inferences?limit=50`);
                renderInferences(inferences);
            } catch (error) {
                console.error('Error loading inferences:', error);
                document.getElementById('inferencesTable').innerHTML = 
                    '<p class="text-center text-muted" style="padding: 2rem;">Failed to load ML events</p>';
            }
        }

        function renderInferences(inferences) {
            const container = document.getElementById('inferencesTable');
            
            if (!inferences || inferences.length === 0) {
                container.innerHTML = '<p class="text-center text-muted" style="padding: 2rem;">No ML events detected yet</p>';
                return;
            }

            // Fixture ‚Üí Room mapping
            const fixtureToRoom = {
                'KitchenFaucet': 'üç≥ Mutfak Musluƒüu',
                'Toilet': 'üöΩ Tuvalet',
                'Shower': 'üöø Du≈ü',
                'Bathtub': 'üõÅ K√ºvet',
                'BathroomFaucet': 'üö∞ Banyo Lavabo',
                'WashingMachine': 'üëï √áama≈üƒ±r Makinesi',
                'Dishwasher': 'üçΩÔ∏è Bula≈üƒ±k Makinesi',
                'GardenHose': 'üå± Bah√ße Hortumu'
            };

            container.innerHTML = `
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="padding: 0.75rem; text-align: left;">Event Time</th>
                                <th style="padding: 0.75rem; text-align: center;">Fixture / Room</th>
                                <th style="padding: 0.75rem; text-align: center;">Duration</th>
                                <th style="padding: 0.75rem; text-align: center;">Water Used</th>
                                <th style="padding: 0.75rem; text-align: center;">Avg Flow</th>
                                <th style="padding: 0.75rem; text-align: center;">Confidence</th>
                                <th style="padding: 0.75rem; text-align: center;">Control</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${inferences.map(inf => `
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 0.75rem;">
                                        <div style="font-weight: 500;">${formatDate(inf.eventStartTs)}</div>
                                        <div style="font-size: 0.875rem; color: #666;">${formatTime(inf.eventStartTs)}</div>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center;">
                                        <div style="font-weight: 600; color: #6366f1;">
                                            ${fixtureToRoom[inf.predictedFixture] || inf.predictedFixture}
                                        </div>
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center;">
                                        ${formatNumber(inf.durationSec)} s
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center; font-weight: 600; color: #3b82f6;">
                                        ${formatNumber(inf.liters)} L
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center;">
                                        ${formatNumber(inf.meanFlowLpm)} L/min
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center;">
                                        ${getConfidenceBadge(inf.confidence)}
                                    </td>
                                    <td style="padding: 0.75rem; text-align: center;">
                                        <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; background: #f0fdf4; color: #166534; font-weight: 500;">
                                            ${inf.controlProfile || 'N/A'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="padding: 1rem; text-align: center; color: #666; font-size: 0.875rem; border-top: 1px solid var(--border-color); background: var(--light-bg);">
                    Showing ${inferences.length} ML detection events
                </div>
            `;
        }

        function getConfidenceBadge(confidence) {
            const pct = (confidence * 100).toFixed(1);
            let color = '#166534'; // green
            let bg = '#f0fdf4';
            
            if (confidence < 0.6) {
                color = '#991b1b'; // red
                bg = '#fef2f2';
            } else if (confidence < 0.8) {
                color = '#92400e'; // yellow
                bg = '#fffbeb';
            }
            
            return `<span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; background: ${bg}; color: ${color}; font-weight: 600;">${pct}%</span>`;
        }

        function renderCommands(commands) {
            const container = document.getElementById('commandsList');
            
            if (commands.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No commands sent</p>';
                return;
            }
            
            container.innerHTML = commands.map(cmd => `
                <div style="border-bottom: 1px solid var(--border-color); padding: 0.75rem 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <span style="font-weight: 500;">${cmd.type.replace(/_/g, ' ')}</span>
                        ${getCommandStatusBadge(cmd.status)}
                    </div>
                    <div class="text-muted" style="font-size: 0.875rem;">
                        ${formatDateTime(cmd.requestedAt)}
                        ${cmd.failureReason ? `<br><span style="color: var(--danger-color);">${cmd.failureReason}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function sendCommand(commandType) {
            try {
                await apiRequest(`/devices/${deviceId}/commands`, {
                    method: 'POST',
                    body: JSON.stringify({ type: commandType, payload: {} })
                });
                showAlert('Command sent successfully', 'success');
                await loadCommands();
            } catch (error) {
                showAlert('Failed to send command: ' + error.message, 'error');
            }
        }

        function showSetFlowModal() {
            document.getElementById('setFlowModal').classList.remove('hidden');
            syncFlowControls();
        }

        function hideSetFlowModal() {
            document.getElementById('setFlowModal').classList.add('hidden');
        }

        function syncFlowControls() {
            const input = document.getElementById('flowRateInput');
            const slider = document.getElementById('flowRateSlider');
            
            input.addEventListener('input', () => {
                slider.value = input.value;
            });
            
            slider.addEventListener('input', () => {
                input.value = slider.value;
            });
        }

        async function sendFlowCommand() {
            const flowRate = document.getElementById('flowRateInput').value;
            
            try {
                await apiRequest(`/devices/${deviceId}/commands`, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        type: 'SET_FLOW_RATE', 
                        payload: { target_flow_lpm: parseFloat(flowRate) }
                    })
                });
                showAlert('Flow rate command sent successfully', 'success');
                hideSetFlowModal();
                await loadCommands();
            } catch (error) {
                showAlert('Failed to send command: ' + error.message, 'error');
            }
        }

        // Load device on page load
        if (deviceId) {
            loadDevice();
        } else {
            showAlert('No device ID provided', 'error');
        }
    </script>
</body>
</html>
